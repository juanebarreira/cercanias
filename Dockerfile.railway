FROM gradle:8.12.0-jdk21-alpine AS build

# Configurar límites de memoria para Gradle
ENV GRADLE_OPTS="-Xmx512m -Xms128m"

# Copiar solo los archivos necesarios para la dependencias primero
COPY build.gradle.kts settings.gradle.kts ./
COPY gradle gradle
COPY gradlew .

# Descargar dependencias con límites de memoria
RUN gradle dependencies --no-daemon --console=plain \
    -Dorg.gradle.jvmargs="-Xmx512m -XX:+HeapDumpOnOutOfMemoryError" \
    -Dorg.gradle.workers.max=2

# Ahora copiar el código fuente
COPY src src

# Compilar con límites de memoria
RUN gradle build --no-daemon --console=plain \
    -Dorg.gradle.jvmargs="-Xmx512m -XX:+HeapDumpOnOutOfMemoryError" \
    -Dorg.gradle.workers.max=2 \
    --exclude-task test

# Segunda etapa: imagen final
FROM eclipse-temurin:21-jre AS runtime

# Instalar Chromium y sus dependencias
RUN apt-get update && apt-get install -y \
    chromium \
    chromium-driver \
    xvfb \
    dumb-init \
    && rm -rf /var/lib/apt/lists/* \
    && mkdir -p /usr/lib/chromium \
    && ln -s /usr/bin/chromium /usr/lib/chromium/chrome

# Crear usuario no root
RUN useradd -m -d /home/chrome chrome \
    && chown -R chrome:chrome /home/chrome \
    && mkdir -p /app/screenshots \
    && chown -R chrome:chrome /app

WORKDIR /app

# Copiar el certificado y configurarlo
COPY api.telegram.org.pem /tmp/
RUN keytool -importcert \
    -alias telegram \
    -cacerts \
    -file /tmp/api.telegram.org.pem \
    -storepass changeit \
    -noprompt

# Copiar el jar compilado desde la etapa de build
COPY --from=build /home/gradle/build/libs/*.jar ./app.jar

# Variables de entorno necesarias
ENV BOT_TOKEN=""
ENV CHAT_ID=""
ENV CHROME_BIN=/usr/lib/chromium/chrome
ENV CHROMEDRIVER_PATH=/usr/bin/chromedriver
ENV DOCKER_ENV=true
ENV TO_TELEGRAM=true
ENV DISPLAY=:99

# Configuraciones de optimización
ENV JAVA_OPTS="-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -Xmx512m -XX:+UseG1GC -XX:+UseStringDeduplication"
ENV CHROME_OPTS="--headless=new --no-sandbox --disable-dev-shm-usage --disable-gpu --disable-software-rasterizer --disable-extensions --disable-dev-tools"

# Script de inicio
RUN echo '#!/bin/sh\nXvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &\nexec java $JAVA_OPTS -jar app.jar' > /app/start.sh \
    && chmod +x /app/start.sh \
    && chown chrome:chrome /app/start.sh

USER chrome

# Usar dumb-init como entrypoint para manejar señales correctamente
ENTRYPOINT ["/usr/bin/dumb-init", "--"]
CMD ["/app/start.sh"] 