FROM gradle:8.12.0-jdk21-alpine AS build

# Copiar solo los archivos necesarios para la dependencias primero
COPY build.gradle.kts settings.gradle.kts ./
COPY gradle gradle
COPY gradlew .

# Descargar dependencias (esto se cachear치 si no cambian los archivos de gradle)
RUN gradle dependencies --no-daemon

# Ahora copiar el c칩digo fuente
COPY src src

# Compilar
RUN gradle build --no-daemon --exclude-task test

# Segunda etapa: imagen final
FROM eclipse-temurin:21-jre AS runtime

# Instalar Chrome y sus dependencias
RUN apt-get update && apt-get install -y \
    chromium \
    chromium-driver \
    fonts-freefont-ttf \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copiar el certificado y configurarlo
COPY api.telegram.org.pem /tmp/
RUN keytool -importcert \
    -alias telegram \
    -cacerts \
    -file /tmp/api.telegram.org.pem \
    -storepass changeit \
    -noprompt

# Copiar el jar compilado desde la etapa de build
COPY --from=build /home/gradle/build/libs/*.jar ./app.jar

# Variables de entorno necesarias
ENV BOT_TOKEN=""
ENV CHAT_ID=""
ENV CHROME_BIN=/usr/bin/chromium
ENV CHROMEDRIVER_PATH=/usr/bin/chromedriver
ENV DOCKER_ENV=true
ENV TO_TELEGRAM=true

# Configuraciones de optimizaci칩n
ENV JAVA_OPTS="-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -Xmx512m -XX:+UseG1GC -XX:+UseStringDeduplication"
ENV CHROME_OPTS="--disable-gpu --no-sandbox --disable-dev-shm-usage --disable-software-rasterizer"

# Crear directorio para screenshots
RUN mkdir -p /app/screenshots

# Comando para ejecutar la aplicaci칩n
ENTRYPOINT ["java"]
CMD ["-XX:+UseContainerSupport", "-XX:MaxRAMPercentage=75.0", "-Xmx512m", "-XX:+UseG1GC", "-XX:+UseStringDeduplication", "-jar", "app.jar"] 